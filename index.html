<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Global Business Trips Q&A Board</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Post questions about global business travel, see what others asked, upvote, and mark addressed‚Äîlive and in real time." />
  <meta property="og:title" content="Global Business Trips Q&A Board" />
  <meta property="og:description" content="Post questions about global business travel, see what others asked, and avoid duplicates." />
  <meta name="theme-color" content="#1b2b59" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --navy-500:#334b7c; --navy-600:#2d3e6a; --navy-700:#24386b; --navy-800:#1b2b59; --navy-900:#0a1738; }
    body { font-family:'Inter',sans-serif; background:linear-gradient(180deg,#f4f8ff 0%,#ffffff 100%); }
    .quote-box { background:linear-gradient(145deg,#e8f0ff,#f9fbff); box-shadow:2px 2px 10px rgba(0,0,0,.08), -2px -2px 10px rgba(255,255,255,.7); border-left:4px solid var(--navy-600); border-radius:.5rem; }
    .plane { position:fixed; top:9vh; left:-12vw; font-size:18px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.15)); animation:plane-fly 3.6s ease-in-out forwards; z-index:60; color:var(--navy-700); }
    @keyframes plane-fly { 0%{transform:translateX(-15%) translateY(0) rotate(0);opacity:0;} 10%{opacity:1;} 60%{transform:translateX(65vw) translateY(-4vh) rotate(1deg);} 100%{transform:translateX(110vw) translateY(-6vh) rotate(2deg);opacity:0;} }
    @keyframes spin-globe { 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
    .rotate-globe { display:inline-block; animation:spin-globe 6s linear infinite; }
    .counter { font-size:.75rem; }
  </style>
</head>
<body class="min-h-screen text-[var(--navy-900)]">
  <div id="effects" class="pointer-events-none fixed inset-0 overflow-hidden z-50"></div>

  <div class="max-w-5xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-[var(--navy-900)] flex items-center gap-2">
        <span class="rotate-globe">üåç</span>
        <span>Global Business Trips Q&A Board</span>
      </h1>

      <!-- Admin toolbar -->
      <div class="flex items-center gap-3">
        <span id="adminStatus" class="text-xs text-[var(--navy-600)]">Viewer</span>
        <button id="adminBtn" class="text-xs px-3 py-1 rounded border border-[var(--navy-400)] hover:bg-[var(--navy-100)]">Admin</button>
        <button id="logoutAdminBtn" class="hidden text-xs px-3 py-1 rounded border border-[var(--navy-400)] hover:bg-[var(--navy-100)]">Admin sign out</button>
      </div>
    </header>

    <blockquote class="quote-box mb-6 p-4 text-sm text-[var(--navy-700)]">
      <span class="font-semibold text-[var(--navy-800)]">‚ÄúA woman in business doesn‚Äôt just chase success ‚Äî she defines it, shapes it, and makes room for others to rise with her.‚Äù</span>
    </blockquote>

    <div id="flash" class="hidden mb-4 p-3 rounded-lg border border-[var(--navy-600)] bg-[var(--navy-100)] text-[var(--navy-800)] text-sm"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ask -->
      <section class="shadow-lg border rounded-xl border-[var(--navy-600)] bg-[var(--navy-700)] text-white" aria-labelledby="askTitle">
        <div id="askTitle" class="p-4 border-b font-semibold">Ask a Question</div>
        <div class="p-4 space-y-3">
          <label class="sr-only" for="name">Your name (optional)</label>
          <input id="name" class="w-full border border-[var(--navy-500)] rounded px-3 py-2 text-[var(--navy-900)] placeholder-[var(--navy-400)] focus:outline-none focus:ring-2 focus:ring-[var(--navy-600)]" placeholder="Your name (optional)" maxlength="80"/>

          <div>
            <label class="sr-only" for="qtext">Type your question‚Ä¶</label>
            <input id="qtext" class="w-full border border-[var(--navy-500)] rounded px-3 py-2 text-[var(--navy-900)] placeholder-[var(--navy-400)] focus:outline-none focus:ring-2 focus:ring-[var(--navy-600)]" placeholder="Type your question‚Ä¶" maxlength="300" />
            <div class="counter text-[var(--navy-100)] mt-1"><span id="qtextCount">0</span>/300</div>
          </div>

          <div>
            <label class="sr-only" for="qdetails">Add context (optional)</label>
            <textarea id="qdetails" rows="4" class="w-full border border-[var(--navy-500)] rounded px-3 py-2 text-[var(--navy-900)] placeholder-[var(--navy-400)] focus:outline-none focus:ring-2 focus:ring-[var(--navy-600)]" placeholder="Add context (optional)" maxlength="1000"></textarea>
            <div class="counter text-[var(--navy-100)] mt-1"><span id="qdetailsCount">0</span>/1000</div>
          </div>

          <!-- Honeypot field (hidden from humans) -->
          <input id="website" type="text" autocomplete="off" tabindex="-1" class="hidden" aria-hidden="true" />

          <button id="postBtn" class="w-full border rounded px-3 py-2 bg-[var(--navy-600)] hover:bg-[var(--navy-500)] text-white transition" aria-label="Post question">‚û§ Post</button>
          <p class="text-xs text-[var(--navy-100)]">Questions are saved securely and update in real time.</p>
        </div>
      </section>

      <!-- List -->
      <section aria-labelledby="listTitle">
        <div class="flex items-center justify-between mb-2">
          <h2 id="listTitle" class="text-[var(--navy-900)] font-semibold">
            Questions <span id="countBadge" class="ml-2 text-xs bg-[var(--navy-200)] text-[var(--navy-900)] px-2 py-1 rounded-full align-middle">0</span>
          </h2>
          <div class="flex items-center gap-2">
            <button id="exportBtn" class="hidden text-xs underline text-[var(--navy-700)] hover:text-[var(--navy-900)]">Export CSV</button>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-2">
          <input id="search" class="w-full border border-[var(--navy-400)] rounded px-3 py-2 text-[var(--navy-900)] placeholder-[var(--navy-400)] focus:outline-none focus:ring-2 focus:ring-[var(--navy-600)]" placeholder="Search questions‚Ä¶" />
          <button id="clearSearch" class="text-xs underline text-[var(--navy-700)]">Clear</button>
        </div>

        <div id="list" class="space-y-3">
          <div class="border rounded-xl p-6 text-center bg-[var(--navy-700)] text-white">
            No questions yet. Be the first to ask about your next business trip!
          </div>
        </div>
        <div id="lastUpdated" class="text-xs text-[var(--navy-500)] mt-2"></div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp,
      updateDoc, doc, increment, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6BS_llfhLtgLgE_nkFS1PYd2rDECoDRo",
      authDomain: "global-business-trips.firebaseapp.com",
      projectId: "global-business-trips",
      storageBucket: "global-business-trips.firebasestorage.app",
      messagingSenderId: "730017594797",
      appId: "1:730017594797:web:44784ebd9c0e9d79a87524",
      measurementId: "G-GXBRGWTY8F"
    };

    // ---------- UI helpers ----------
    const flash = (msg) => {
      const el = document.getElementById("flash");
      if (!el) return;
      el.textContent = msg;
      el.classList.remove("hidden");
      clearTimeout(window.__flashTimer);
      window.__flashTimer = setTimeout(() => el.classList.add("hidden"), 4000);
    };
    const tips = [
      "Posted! Another suitcase of wisdom just hit the carousel.",
      "Question queued. Boarding wisdom shortly ‚úàÔ∏è",
      "Thanks‚Äîyour question just upgraded everyone‚Äôs itinerary.",
      "Nice one! Curiosity is the best frequent-flyer program.",
      "Logged! The only bad question is the one that misses its flight.",
      "Added‚Äîgreat minds travel together.",
      "Submitted! We‚Äôll tackle this before the seatbelt sign is off.",
      "Up next: answers with extra legroom."
    ];
    const celebrate = () => {
      const layer = document.getElementById('effects');
      if (!layer) return;
      const plane = document.createElement('div');
      plane.className = 'plane';
      plane.textContent = '‚úàÔ∏è';
      layer.appendChild(plane);
      setTimeout(() => plane.remove(), 3800);
    };

    // ---------- Firebase init ----------
    let app, auth, db;
    try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); }
    catch (e) { console.error(e); flash("‚ö†Ô∏è Firebase not configured: " + (e.message || e.code)); }

    // ---------- Render state (MUST come before admin UI uses render) ----------
    let items = [];
    let search = "";
    const listEl = document.getElementById("list");
    const countBadge = document.getElementById("countBadge");
    const updatedEl = document.getElementById("lastUpdated");
    let uiReady = false; // becomes true after render() is defined

    const qtext = document.getElementById("qtext");
    const qdetails = document.getElementById("qdetails");
    const qtextCount = document.getElementById("qtextCount");
    const qdetailsCount = document.getElementById("qdetailsCount");
    const updateCounts = () => { qtextCount.textContent = qtext.value.length; qdetailsCount.textContent = qdetails.value.length; };
    qtext.addEventListener("input", updateCounts);
    qdetails.addEventListener("input", updateCounts);
    updateCounts();

    function fmtDate(ts) {
      try { const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null); return d ? d.toLocaleString() : ""; }
      catch { return ""; }
    }

    function render() {
      if (!uiReady) return; // guard during early init
      listEl.innerHTML = "";
      const q = search.toLowerCase().trim();
      const filtered = items
        .filter(x => !q || x.text?.toLowerCase().includes(q) || (x.details||"").toLowerCase().includes(q) || (x.name||"").toLowerCase().includes(q))
        .sort((a,b) => (b.upvotes||0) - (a.upvotes||0));

      countBadge.textContent = String(filtered.length);

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "border rounded-xl p-6 text-center bg-[var(--navy-700)] text-white";
        empty.textContent = "No questions yet. Be the first to ask about your next business trip!";
        listEl.appendChild(empty);
        updatedEl.textContent = "";
        return;
      }

      updatedEl.textContent = "Last updated: " + new Date().toLocaleTimeString();

      filtered.forEach(item => {
        const card = document.createElement("div");
        card.className = "shadow-md border border-[var(--navy-400)] rounded-xl bg-[var(--navy-600)] text-white hover:shadow-lg transition";
        const created = fmtDate(item.createdAt);
        card.innerHTML = `
          <div class="p-4 flex items-start gap-3">
            <button class="rounded-xl px-3 py-2 border border-[var(--navy-400)] hover:bg-[var(--navy-500)] transition" aria-label="Upvote">
              <div class="text-sm text-white">üëçüèΩ <span class="uv">${item.upvotes||0}</span></div>
            </button>
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <div class="font-medium text-white truncate">${item.text}</div>
                <span class="text-xs bg-[var(--navy-500)] text-white px-2 py-1 rounded">${item.addressed ? "‚úî Addressed" : "‚è≥ Open"}</span>
              </div>
              ${item.details ? `<p class="text-sm text-[var(--navy-100)] mt-1 whitespace-pre-wrap">${item.details}</p>` : ""}
              <div class="mt-2 text-xs text-[var(--navy-200)] flex flex-wrap gap-2">
                ${item.name ? `Asked by <span class='font-medium text-white'>${item.name}</span>` : ""}
                ${created ? `¬∑ <span>${created}</span>` : ""}
              </div>
            </div>
            <div class="flex flex-col items-end gap-2 ml-2" id="adminArea"></div>
          </div>`;

        // Upvote
        card.querySelector("button").onclick = async () => {
          try { await updateDoc(doc(db, "questions", item.id), { upvotes: increment(1) }); }
          catch (e) { flash("‚ö†Ô∏è Upvote failed: " + (e.message || e.code)); }
        };

        // Admin controls (insert only if admin)
        if (isAdmin) {
          const adminArea = card.querySelector("#adminArea");
          const toggleBtn = document.createElement("button");
          toggleBtn.className = "text-xs underline";
          toggleBtn.textContent = item.addressed ? "Unmark" : "Mark addressed";
          toggleBtn.onclick = async () => {
            try { await updateDoc(doc(db, "questions", item.id), { addressed: !item.addressed }); }
            catch (e) { flash("‚ö†Ô∏è Update failed: " + (e.message || e.code)); }
          };
          adminArea.appendChild(toggleBtn);

          if (item.addressed) {
            const rm = document.createElement("button");
            rm.className = "text-xs underline";
            rm.textContent = "Remove";
            rm.onclick = async () => {
              if (!confirm("Remove this addressed question?")) return;
              try { await deleteDoc(doc(db, "questions", item.id)); }
              catch (e) { flash("‚ö†Ô∏è Delete failed: " + (e.message || e.code)); }
            };
            adminArea.appendChild(rm);
          }
        }

        listEl.appendChild(card);
      });
    }
    uiReady = true; // render can now run safely

    // ---------- Admin UI ----------
    let isAdmin = localStorage.getItem("isAdmin") === "1";
    const adminBtn = document.getElementById("adminBtn");
    const logoutAdminBtn = document.getElementById("logoutAdminBtn");
    const adminStatus = document.getElementById("adminStatus");
    const exportBtn = document.getElementById("exportBtn");

    function setAdminUI(state) {
      isAdmin = !!state;
      adminStatus.textContent = isAdmin ? "Admin" : "Viewer";
      exportBtn.classList.toggle("hidden", !isAdmin);
      logoutAdminBtn.classList.toggle("hidden", !isAdmin);
      localStorage.setItem("isAdmin", isAdmin ? "1" : "0");
      render(); // now safe
    }
    setAdminUI(isAdmin); // reflect persisted state

    async function enterAdmin() {
      const input = prompt("Enter admin passcode:");
      if (input === null) return;
      try {
        const snap = await getDoc(doc(db, "settings", "admin"));
        if (!snap.exists()) return flash("Admin error: settings/admin document not found.");
        const saved = String(snap.data()?.code ?? "").trim(); // number or string
        if (!saved) return flash("Admin error: passcode not set.");
        if (String(input).trim() === saved) { setAdminUI(true); flash("Admin mode enabled."); }
        else { setAdminUI(false); flash("Invalid passcode or permission denied."); }
      } catch (e) { setAdminUI(false); flash("Admin check failed: " + (e.message || e.code)); console.error(e); }
    }
    function exitAdmin(){ setAdminUI(false); flash("Admin mode disabled."); }

    adminBtn.onclick = enterAdmin;
    logoutAdminBtn.onclick = exitAdmin;

    // ---------- Auth + realtime feed ----------
    if (auth) {
      onAuthStateChanged(auth, async (user) => {
        try { if (!user) await signInAnonymously(auth); }
        catch (e) { return flash("‚ö†Ô∏è Auth error: " + (e.message || e.code)); }

        const qRef = query(
          collection(db, "questions"),
          orderBy("upvotes","desc"),
          orderBy("createdAt","desc")
        );

        onSnapshot(qRef, (snap) => { items = snap.docs.map(d => ({ id:d.id, ...d.data() })); render(); },
          (err) => flash("‚ö†Ô∏è Firestore read error: " + (err.message || err.code)));
      });
    }

    // ---------- Post (cooldown + honeypot) ----------
    document.getElementById("postBtn").onclick = async () => {
      const text = qtext.value.trim();
      if (!text) return alert("Please enter a question.");
      if (document.getElementById("website").value.trim()) return flash("Submission blocked.");

      const last = Number(localStorage.getItem("lastPostTs") || 0);
      const now = Date.now(), cooldownMs = 30_000;
      if (now - last < cooldownMs) {
        const wait = Math.ceil((cooldownMs - (now - last))/1000);
        return flash(`Please wait ${wait}s before posting again.`);
      }

      const payload = {
        text,
        details: qdetails.value.trim(),
        name: document.getElementById("name").value.trim(),
        upvotes: 1,
        addressed: false,
        createdAt: serverTimestamp()
      };

      try {
        await addDoc(collection(db, "questions"), payload);
        qtext.value = ""; qdetails.value = ""; updateCounts();
        flash(tips[Math.floor(Math.random() * tips.length)]);
        celebrate();
        localStorage.setItem("lastPostTs", String(Date.now()));
      } catch (e) { flash("‚ö†Ô∏è Post failed: " + (e.message || e.code)); console.error(e); }
    };

    // ---------- Search ----------
    document.getElementById("search").oninput = (e) => { search = e.target.value; render(); };
    document.getElementById("clearSearch").onclick = () => { document.getElementById("search").value = ""; search = ""; render(); };

    // ---------- CSV export (admin only) ----------
    exportBtn.onclick = () => {
      if (!isAdmin) return flash("Admin only.");
      if (!items.length) return flash("Nothing to export yet.");
      const header = ["id","name","text","details","upvotes","addressed","createdAt"];
      const rows = items.map(x => [
        x.id,
        (x.name||"").replaceAll('"','""'),
        (x.text||"").replaceAll('"','""'),
        (x.details||"").replaceAll('"','""'),
        x.upvotes||0,
        x.addressed ? "true":"false",
        fmtDate(x.createdAt)
      ]);
      const csv = [header,...rows].map(r => r.map(v => `"${v}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "questions.csv"; a.click();
      URL.revokeObjectURL(url);
    };
  </script>

  <footer class="mt-12 text-center text-sm text-[var(--navy-700)] border-t border-[var(--navy-100)] py-6">
    ¬© 2025 Global Business Trips ‚Äî All Rights Reserved
  </footer>
</body>
</html>
